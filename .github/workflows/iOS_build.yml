# .github/workflows/ios_build.yml
name: iOS_build

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    name: Build iOS App
    runs-on: macos-15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4 # æ£€å‡ºä½ çš„ä»£ç ä»“åº“

      # è®¾ç½®Flutter
    - name: Flutter action
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.29.3'
        cache: true 

    - name: Get Flutter dependencies
      run: 
           cd simple_live_app
           flutter pub get # ä¸‹è½½é¡¹ç›®ä¾èµ–
           
   # è®¾ç½®flutter_distributorç¯å¢ƒ
    - name: Install flutter_distributor
      run: dart pub global activate flutter_distributor

   #æ‰“åŒ…iOS
    - name: Build IPA
      run: |
         cd simple_live_app
         flutter build ios --release --no-codesign
         
         # è®¾ç½®ç‰ˆæœ¬å·å’Œæ—¥æœŸä½œä¸ºç¯å¢ƒå˜é‡
         VERSION=$(grep 'version:' pubspec.yaml | awk '{print $2}' | cut -d'+' -f1)
         echo "APP_VERSION=$VERSION" >> $GITHUB_ENV
         echo "BUILD_DATE=$(date +'%Y%m%d')" >> $GITHUB_ENV

   #åˆ›å»ºæœªç­¾åipa
    - name: Create IPA
      run: |
        cd simple_live_app
        mkdir build/ios/iphoneos/Payload
        cp -R build/ios/iphoneos/Runner.app build/ios/iphoneos/Payload/Runner.app
        cd build/ios/iphoneos/
        zip -q -r ios_no_sign.ipa Payload
        # é‡å‘½åIPAæ–‡ä»¶ä»¥åŒ…å«ç‰ˆæœ¬å·
        cp ios_no_sign.ipa SimpleLive-${{ env.APP_VERSION }}-ios.ipa
        cd ../../..

    # ä¸Šä¼ IPAè‡³Artifacts
    - name: Upload IPA to Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ios
        path: |
          simple_live_app/build/ios/iphoneos/ios_no_sign.ipa
          simple_live_app/build/ios/iphoneos/SimpleLive-${{ env.APP_VERSION }}-ios.ipa
          
    # åˆ›å»ºGitHub Releaseå¹¶ä¸Šä¼ IPA
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ env.APP_VERSION }}-iOS-${{ env.BUILD_DATE }}
        name: SimpleLive iOS v${{ env.APP_VERSION }} (${{ env.BUILD_DATE }})
        draft: false
        prerelease: false
        files: |
          simple_live_app/build/ios/iphoneos/SimpleLive-${{ env.APP_VERSION }}-ios.ipa
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
             
    #å®Œæˆ
    - run: echo "ğŸ This job's status is ${{ job.status }}."

# .github/workflows/Android_build.yml
name: Android_build

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    name: Build Android App
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # è®¾ç½® Java ç¯å¢ƒ
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu' # æˆ–å…¶ä»– JDK å‘è¡Œç‰ˆ
        java-version: '17' # Flutter éœ€è¦çš„ JDK ç‰ˆæœ¬
        cache: "gradle"

    # è®¾ç½®Flutter
    - name: Flutter action
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.29.3'
        cache: true

    - name: Get Flutter dependencies
      run: |
        cd simple_live_app
        flutter pub get # ä¸‹è½½é¡¹ç›®ä¾èµ–

    # è®¾ç½® flutter_distributor ç¯å¢ƒ
    - name: Install flutter_distributor
      run: dart pub global activate flutter_distributor
      
    #APKç­¾åè®¾ç½®
    - name: Generate Random Keystore
      run: |
        # åˆ›å»ºå¯†é’¥åº“ç›®å½•
        mkdir -p simple_live_app/android/keystore
        
        # é…ç½®ç§˜é’¥
        STORE_PASSWORD="${{ secrets.STORE_PASSWORD }}"
        KEY_PASSWORD="${{ secrets.KEY_PASSWORD }}"
        KEY_ALIAS="${{ secrets.KEY_ALIAS }}"
        
        # ç”Ÿæˆå¯†é’¥åº“
        keytool -genkeypair \
        -keystore simple_live_app/android/keystore/keystore.jks \
        -alias $KEY_ALIAS \
        -keyalg RSA \
        -keysize 2048 \
        -validity 9125 \
        -storepass $STORE_PASSWORD \
        -keypass $KEY_PASSWORD \
        -dname "CN=Simple Live,OU=Android,O=Android,L=Android,S=Android,C=US" \
        -storetype JKS
        
        # åˆ›å»ºkey.propertiesæ–‡ä»¶åˆ°æŒ‡å®šè·¯å¾„
        echo "storeFile=../keystore/keystore.jks" > simple_live_app/android/key.properties
        echo "storePassword=$STORE_PASSWORD" >> simple_live_app/android/key.properties
        echo "keyPassword=$KEY_PASSWORD" >> simple_live_app/android/key.properties
        echo "keyAlias=$KEY_ALIAS" >> simple_live_app/android/key.properties

        # ç¡®ä¿keystoreæƒé™æ­£ç¡®
        chmod 644 simple_live_app/android/keystore/keystore.jks
        
    # æ„å»º Android APK (Release ç‰ˆæœ¬)
    - name: Build APK
      id: build_apk
      run: |
        cd simple_live_app
        flutter build apk --release --target-platform android-arm64
        
        # è®¾ç½®ç‰ˆæœ¬å·å’Œæ—¥æœŸä½œä¸ºç¯å¢ƒå˜é‡
        VERSION=$(grep 'version:' pubspec.yaml | awk '{print $2}' | cut -d'+' -f1)
        echo "APP_VERSION=$VERSION" >> $GITHUB_ENV
        echo "BUILD_DATE=$(date +'%Y%m%d')" >> $GITHUB_ENV
        
        # é‡å‘½åAPKæ–‡ä»¶ä»¥åŒ…å«ç‰ˆæœ¬å·
        cp build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/SimpleLive-$VERSION-release.apk

    # ä¸Šä¼  APKè‡³ Artifacts
    - name: Upload APK to Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: android-apk # Artifact åç§°
        # Release APK çš„é»˜è®¤è¾“å‡ºè·¯å¾„
        path: simple_live_app/build/app/outputs/flutter-apk/*.apk
        
    # åˆ›å»ºGitHub Releaseå¹¶ä¸Šä¼ APK
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ env.APP_VERSION }}-${{ env.BUILD_DATE }}
        name: SimpleLive v${{ env.APP_VERSION }} (${{ env.BUILD_DATE }})
        draft: false
        prerelease: false
        files: |
          simple_live_app/build/app/outputs/flutter-apk/SimpleLive-${{ env.APP_VERSION }}-release.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # å®Œæˆ
    - run: echo "ğŸ¤– This job's status is ${{ job.status }}."
